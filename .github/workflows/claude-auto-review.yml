name: Claude Auto Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  review:
    # Don't run on bot commits to prevent loops
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "claude[bot]"
          git config user.email "claude[bot]@users.noreply.github.com"

      - name: Claude Iterative Review & Fix
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --max-turns 5
          prompt: |
            Perform an iterative code review and fix loop for this PR:

            ## Review Process (Max 5 Iterations)

            1. **REVIEW**: Analyze all PR changes for issues in these areas:
               - TypeScript type errors and type safety issues
               - ESLint violations and code style inconsistencies
               - Security vulnerabilities (XSS, injection, auth bypasses, etc.)
               - Test failures and missing test coverage

            2. **FIX**: If issues found:
               - Fix each issue systematically
               - Run quality checks:
                 ```bash
                 npm run build     # TypeScript compilation
                 npm run lint      # ESLint checks
                 npm run test:run  # Run test suite
                 ```
               - If all checks pass, commit the fixes:
                 ```bash
                 git add .
                 git commit -m "[skip ci] fix: <clear description of what was fixed>"
                 git push
                 ```
               - Go back to step 1 (review again)

            3. **COMPLETE**: If no issues found OR max iterations (5) reached:
               - Post a summary comment on the PR with:
                 - Number of iterations completed
                 - Issues fixed (with categories: TypeScript, ESLint, Security, Tests)
                 - Final status (all clean / issues remaining / max iterations reached)
                 - Any recommendations for manual review

            ## Important Guidelines

            - Follow project code style from .claude/CLAUDE.md
            - Only commit if tests pass - DO NOT commit broken code
            - Use conventional commit format: "fix:", "refactor:", "test:", etc.
            - Always include [skip ci] to prevent triggering this workflow again
            - Be thorough but respect the 5 iteration limit
            - If stuck on an issue after 2 attempts, document it and move on

            ## Focus Areas Priority

            1. Security vulnerabilities (highest priority)
            2. TypeScript type errors (breaks build)
            3. Test failures (breaks CI)
            4. ESLint violations (code quality)
