name: Claude Security Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'src/**/*.ts'
      - 'src/**/*.tsx'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'

permissions:
  pull-requests: write
  contents: read

jobs:
  security-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        # Pinned to v4.3.1 for supply chain security
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 2

      - name: Claude Security Review
        # Pinned to latest main commit for supply chain security
        uses: anthropics/claude-code-security-review@25e460eb0a12077f0c6a1934d5dbae2f50785dda
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-pr: true
          # Optional: customize the security review focus
          prompt: |
            Perform a comprehensive security review of this PR with focus on:

            ## Web Application Security
            - XSS (Cross-Site Scripting) vulnerabilities
            - DOM-based vulnerabilities
            - Unsafe innerHTML/dangerouslySetInnerHTML usage
            - User input validation and sanitization

            ## Authentication & Authorization
            - Authentication bypass opportunities
            - Authorization flaws
            - Session management issues
            - Token handling and storage

            ## Data Security
            - Sensitive data exposure
            - Insecure data storage (localStorage, sessionStorage)
            - API key or secret leakage
            - Privacy concerns

            ## Dependencies
            - Vulnerable package versions in package.json
            - Supply chain risks
            - Malicious dependencies

            ## Audio/Media Specific Risks (for this project)
            - Audio file parsing vulnerabilities
            - Buffer overflow in audio processing
            - Resource exhaustion attacks
            - Unsafe Web Audio API usage

            ## Code Injection
            - eval() or Function() constructor misuse
            - Template injection
            - Prototype pollution

            ## Client-Side Security
            - CORS misconfigurations
            - Insecure third-party integrations
            - Browser API misuse

            ## Rate this PR's security impact:
            - ðŸ”´ Critical: Immediate security risk
            - ðŸŸ¡ Medium: Potential vulnerability
            - ðŸŸ¢ Low: No significant security concerns

            If you find issues, provide:
            1. Clear description of the vulnerability
            2. Code location (file and line)
            3. Severity level
            4. Exploitation scenario
            5. Recommended fix
